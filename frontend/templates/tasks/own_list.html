{% extends 'base.html' %}

{% block title %}
    Мои задачи
{% endblock %}

{% block content %}
    <h1>Мои задачи</h1>

    <table border="1" cellpadding="6" style="width: 100%; border-collapse: collapse">
        <thead>
        <tr>
            <th>Название</th>
            <th>Описание</th>
            <th>Срок исполнения</th>
            <th>Статус</th>
            <th>Создатель</th>
            <th>Оценка</th>
            <th>Создано</th>
            <th>Комментарии</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody id="tasks-body">
        <tr>
            <td colspan="10">Загрузка...</td>
        </tr>
        </tbody>
    </table>

    <p id="error" style="color: red"></p>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (!Auth.isAuthenticated()) {
                window.location.href = URLS.login;
                return;
            }

            const response = await fetchWithAuth(URLS.tasksOwnListAPI);

            if (!response.ok) {
                document.getElementById('error').textContent = 'Ошибка загрузки списка задач';
                document.getElementById('tasks-body').innerHTML = '';
                return;
            }

            const tasks = await response.json();
            const tbody = document.getElementById('tasks-body');
            tbody.innerHTML = '';

            if (!tasks.length) {
                tbody.innerHTML = '<tr><td colspan="9">У вас пока нет задач</td></tr>';
                return;
            }

            tasks.forEach(task => {
                const deadline = task.deadline ? new Date(task.deadline).toLocaleString() : '---';

                const createdAt = new Date(task.created_at).toLocaleDateString();

                const author = task.created_by_email ? `${task.created_by_email} (${task.created_by_first_name} ${task.created_by_last_name})` : '---';

                const rank = task.rank !== null ? task.rank : '---';

                const statusText = {
                    'open': 'Открытая',
                    'in_progress': 'В работе',
                    'done': 'Выполнена'
                }[task.status] || task.status;

                const commentsCount = task.comments?.length || 0;
                let commentsHtml = '---';
                if (commentsCount > 0) {
                    commentsHtml = task.comments.map(c => {
                        const authorName = c.author_email;
                        return `<div><strong>${authorName}:</strong> ${c.text.substring(0, 60)}${c.text.length > 60 ? '...' : ''}</div>`;
                    }).join('');
                }

                tbody.insertAdjacentHTML('beforeend', `
                    <tr data-task-id="${task.id}">
                        <td>${task.title}</td>
                        <td>${task.description ? task.description.substring(0, 80) + (task.description.length > 80 ? '...' : '') : '---'}</td>
                        <td>${deadline}</td>
                        <td>${statusText}</td>
                        <td>${author}</td>
                        <td>${rank}</td>
                        <td>${createdAt}</td>
                        <td style="max-width: 200px; overflow: hidden;">
                            ${commentsHtml}
                        </td>
                        <td>
                            <a href="#" onclick="alert('Детальная страница задачи пока не реализована (ID: ${task.id})'); return false;">Просмотр</a>
                        </td>
                    </tr>
                `);
            });
        });
    </script>
{% endblock %}