{% extends 'base.html' %}

{% block title %}
    Список всех задач
{% endblock %}

{% block content %}
    <h1>Список всех созданных задач</h1>

    <table border="1" cellpadding="6" style="width: 100%; border-collapse: collapse">
        <thead>
        <tr>
            <th>ID</th>
            <th>Название</th>
            <th>Описание</th>
            <th>Команда</th>
            <th>Срок</th>
            <th>Статус</th>
            <th>Исполнитель</th>
            <th>Оценка</th>
            <th>Создано</th>
            <th>Комментарии</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody id="tasks-body">
        <tr>
            <td colspan="10">Загрузка...</td>
        </tr>
        </tbody>
    </table>

    <p id="error" style="color: red"></p>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (!Auth.isAuthenticated()) {
                window.location.href = URLS.login;
                return;
            }

            const payload = getJwtPayload();
            if (!payload || payload.role !== 'admin') {
                document.getElementById('error').textContent =
                    'Доступ запрещён. Только для администраторов.';
                document.getElementById('tasks-body').innerHTML = '';
                return;
            }

            const response = await fetchWithAuth(URLS.tasksAdminListAPI);

            if (!response.ok) {
                document.getElementById('error').textContent = 'Ошибка загрузки списка задач';
                document.getElementById('tasks-body').innerHTML = '';
                return;
            }

            const tasks = await response.json();
            const tbody = document.getElementById('tasks-body');
            tbody.innerHTML = '';

            if (!tasks.length) {
                tbody.innerHTML = '<tr><td colspan="10">Задачи не найдены</td></tr>';
                return;
            }

            tasks.forEach(task => {
                const deadline = task.deadline ? new Date(task.deadline).toLocaleString() : '---';

                const createdAt = new Date(task.created_at).toLocaleDateString();

                const assigned = task.assigned_to_email ? `${task.assigned_to_email} (${task.assigned_to_first_name} ${task.assigned_to_last_name})` : '---';

                const teamName = task.team_name ?? '---';

                const commentsCount = task.comments ? task.comments.length : 0;
                let commentsHtml = '';
                if (commentsCount > 0) {
                    commentsHtml = task.comments.map(c =>
                        `<div><strong>${c.author_email}:</strong> ${c.text.substring(0, 60)}${c.text.length > 60 ? '...' : ''}</div>`
                    ).join('');
                } else {
                    commentsHtml = '---';
                }

                const statusText = {
                    'open': 'Открытая',
                    'in_progress': 'В работе',
                    'done': 'Выполнена'
                }[task.status] || task.status;

                let rankDisplay = '';
                if (task.rank !== null && task.rank !== undefined) {
                    rankDisplay = `
                        Оценено: ${task.rank}
                        <button onclick="deleteEvaluation(${task.id})">Удалить</button>
                    `
                } else if (task.status === 'done') {
                    rankDisplay = `
                        <select id="eval-rank-${task.id}">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                        <button onclick="createEvaluation(${task.id})">Оценить</button>
                    `;
                } else {
                    rankDisplay = 'Нельзя оценить';
                }

                tbody.insertAdjacentHTML('beforeend', `
                    <tr data-task-id="${task.id}">
                        <td>${task.id}</td>
                        <td>${task.title}</td>
                        <td>${task.description ? task.description.substring(0, 80) + (task.description.length > 80 ? '...' : '') : '---'}</td>
                        <td>${teamName}</td>
                        <td>${deadline}</td>
                        <td>${statusText}</td>
                        <td>${assigned}</td>
                        <td>${rankDisplay}</td>
                        <td>${createdAt}</td>
                        <td style="max-width: 200px; overflow: hidden;">
                            ${commentsHtml}
                        </td>
                        <td>
                            <a href="#" onclick="goToUpdateTask(${task.id}, ${task.team_id || 'unknown'}); return false;">Редактировать</a>
                            <hr>
                            <button onclick="deleteTask(${task.team_id}, ${task.id}, ${task.title})">Удалить</button>
                            <hr>
                            <div>
                                <input type="text" placeholder="Комментарий" id="add-comment-admin-${task.id}"
                                style="width: 200px">
                                <button onclick="addComment(${task.id})">Добавить</button>
                            </div>
                        </td>
                    </tr>
                `);
            });
        });

        async function deleteTask(teamId, taskId, title) {
            if (!confirm(`Удалить задачу "${title}"?`)) {
                return;
            }

            const deleteUrl = URLS.tasksDeleteAPI.replace('/0/0', `/${teamId}/${taskId}/`).replace('/0', `/${teamId}`).replace('/0', `/${taskId}`);

            try {
                const response = await fetchWithAuth(deleteUrl, {method: 'DELETE'});

                if (response.status === 403) {
                    alert('Недостаточно прав для удаления');
                    return;
                }

                if (!response.ok) {
                    alert('Ошибка при удалении задачи');
                    return;
                }

                const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
                if (row) {
                    row.remove();
                }

                alert('Задача удалена');
            } catch (err) {
                alert('Сетевая ошибка при удалении');
                console.error(err);
            }
        }

        function goToUpdateTask(taskId, teamId) {
            if (teamId === 'unknown' || !teamId) {
                alert('Не удалось определить ID команды задачи');
                return;
            }

            window.location.href = URLS.tasksUpdate
                .replace('/0/0', `/${teamId}/${taskId}/`)
                .replace('/0', `/${teamId}`)
                .replace('/0', `/${taskId}`);
        }

        async function addComment(taskId) {
            const input = document.getElementById(`add-comment-admin-${taskId}`);
            const comment = input.value.trim();

            if (!comment) {
                alert('Введите комментарий');
                return;
            }

            const response = await fetchWithAuth(
                URLS.tasksAddCommentAPI.replace('/0', `/${taskId}`),
                {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text: comment})
                }
            );

            const data = await response.json();

            if (!response.ok) {
                alert(data.detail || 'Ошибка добавления комментария');
                return;
            }

            alert('Комментарий успешно добавлен');
            input.value = '';
            location.reload()
        }

        async function createEvaluation(taskId) {
            const select = document.getElementById(`eval-rank-${taskId}`);
            if (!select) return;

            const rank = parseInt(select.value);
            if (!rank || rank < 1 || rank > 5) {
                alert('Выберите оценку от 1 до 5');
                return;
            }

            const apiUrl = URLS.evaluationsCreateAPI.replace('/0', `/${taskId}`);

            try {
                const response = await fetchWithAuth(apiUrl, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({rank: rank})
                });

                if (response.status === 403) {
                    alert('Недостаточно прав для оценки');
                    return;
                }

                if (!response.ok) {
                    const data = await response.json();
                    alert(data.detail || data.task?.[0] || 'Ошибка при сохранении оценки');
                    return;
                }

                const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
                if (row) {
                    const evalCell = row.querySelector('td:nth-child(8)');
                    if (evalCell) {
                        evalCell.innerHTML = `Оценено: ${rank}`;
                    }
                }

                alert('Оценка поставлена');
            } catch (err) {
                alert('Ошибка сети');
                console.error(err);
            }
            location.reload()
        }

        async function deleteEvaluation(taskId) {
            if (!confirm('Удалить оценку этой задачи?')) {
                return;
            }

            const apiUrl = URLS.evaluationsDeleteAPI.replace('/0', `/${taskId}`);

            try {
                const response = await fetchWithAuth(apiUrl, {
                    method: 'DELETE'
                });

                if (response.status === 403) {
                    alert('Нет прав для удаления оценки');
                    return;
                }

                if (!response.ok) {
                    let data;
                    try {
                        data = await response.json();
                    } catch {
                    }
                    alert(data?.detail || 'Ошибка удаления оценки');
                    return;
                }
                alert('Оценка удалена');
            } catch (err) {
                console.error(err);
                alert('Ошибка при удалении');
            }
            location.reload()
        }
    </script>
{% endblock %}