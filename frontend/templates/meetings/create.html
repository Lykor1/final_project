{% extends 'base.html' %}

{% block title %}
    Создание встречи
{% endblock %}

{% block content %}
    <h1>Создание встречи</h1>

    <form id="meeting-create-form">
        <div>
            <label>Тема встречи</label><br>
            <input type="text" id="topic" required minlength="3">
        </div>
        <div>
            <label>Дата</label><br>
            <input type="date" id="date" required>
        </div>
        <div>
            <label>Время начала</label><br>
            <input type="time" id="start_time" required>
        </div>
        <div>
            <label>Время окончания</label><br>
            <input type="time" id="end_time" required>
        </div>
        <div>
            <label>Участники (email через запятую)</label><br>
            <input type="text" id="members" placeholder="email1@example.com, email2@example.com, ...">
            <p style="font-size: 0.9em; color: gray">Создатель добавляется автоматически</p>
        </div>

        <button type="submit">Создать встречу</button>
        <a href="{% url 'frontend:index' %}">Назад</a>
    </form>

    <p id="error" style="color: red"></p>
    <p id="success" style="color: green"></p>

    <script>
        document.getElementById('meeting-create-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const topic = document.getElementById('topic').value.trim();
            const date = document.getElementById('date').value;
            const start_time = document.getElementById('start_time').value;
            const end_time = document.getElementById('end_time').value;
            const membersInput = document.getElementById('members').value.trim();

            if (!topic || !date || !start_time || !end_time) {
                document.getElementById('error').textContent = 'Заполните все обязательные поля';
                return;
            }

            const members = membersInput ? membersInput.split(',').map(m => m.trim()).filter(m => m) : [];

            const payload = {
                topic,
                date,
                start_time,
                end_time,
                members
            };

            try {
                const response = await fetchWithAuth(URLS.meetingsCreateAPI, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) {
                    document.getElementById('error').textContent = data.detail || data.members?.[0] || data.non_field_errors?.[0] ||
                        JSON.stringify(data) || 'Ошибка сервера';
                    document.getElementById('success').textContent = '';
                    return;
                }

                document.getElementById('error').textContent = '';
                document.getElementById('success').textContent = 'Встреча успешно создана';

                setTimeout(() => {
                    window.location.href = URLS.index;
                }, 1500);

            } catch (err) {
                console.error(err);
                document.getElementById('error').textContent = 'Сетевая ошибка или проблема с соединением';
            }
        });
    </script>
{% endblock %}