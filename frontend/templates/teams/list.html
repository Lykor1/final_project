{% extends 'base.html' %}

{% block title %}
    Команды
{% endblock %}

{% block content %}
    <h1>Список команд</h1>

    <table border="1" cellpadding="6">
        <thead>
        <tr>
            <th>ID</th>
            <th>Название</th>
            <th>Описание</th>
            <th>Создатель</th>
            <th>Участники</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody id="teams-body">
        <tr>
            <td colspan="6">Загрузка...</td>
        </tr>
        </tbody>
    </table>

    <p id="error" style="color: red"></p>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (!Auth.isAuthenticated()) {
                window.location.href = URLS.login;
                return;
            }

            const payload = getJwtPayload();
            if (!payload || payload.role !== 'admin') {
                document.getElementById('error').textContent =
                    'Доступ запрещён. Только для администраторов.';
                document.getElementById('teams-body').innerHTML = '';
                return;
            }

            const response = await fetchWithAuth(URLS.teamsListAPI);

            if (!response.ok) {
                document.getElementById('error').textContent =
                    'Ошибка загрузки списка команд';
                return;
            }

            const teams = await response.json();
            const tbody = document.getElementById('teams-body');
            tbody.innerHTML = '';

            if (!teams.length) {
                tbody.innerHTML =
                    '<tr><td colspan="6">Команды не найдены</td></tr>';
                return;
            }

            teams.forEach(team => {
                const members = team.members.map(m => `${m.full_name} (${m.email})`).join('<br>');

                tbody.insertAdjacentHTML('beforeend', `
                    <tr data-team-id="${team.id}">
                        <td>${team.id}</td>
                        <td>${team.name}</td>
                        <td>${team.description || '---'}</td>
                        <td>${team.creator.full_name} (${team.creator.email})</td>
                        <td>${members || '---'}</td>
                        <td>
                            <button onclick="deleteTeam(${team.id})">Удалить</button>
                            <hr>
                            <button onclick="updateTeam(${team.id})">Редактировать</button>
                            <hr>
                            <div>
                                <input type="email" placeholder="email пользователя" id="add-user-email-${team.id}"
                                style="width: 200px">
                                <button onclick="addUserToTeam(${team.id})">Добавить</button>
                            </div>
                        </td>
                    </tr>
                `);
            });
        });

        async function deleteTeam(teamId) {
            if (!confirm('Удалить команду?')) return;

            const response = await fetchWithAuth(
                URLS.teamsDeleteAPI.replace('/0', `/${teamId}`),
                {method: 'DELETE'}
            );

            if (response.status === 403) {
                alert('Недостаточно прав');
                return;
            }

            if (!response.ok) {
                alert('Ошибка удаления команды');
                return;
            }

            document.querySelector(`tr[data-team-id="${teamId}"]`)?.remove();
        }

        async function addUserToTeam(teamId) {
            const input = document.getElementById(`add-user-email-${teamId}`);
            const email = input.value.trim();

            if (!email) {
                alert('Введите email пользователя');
                return;
            }

            const response = await fetchWithAuth(
                URLS.teamsAddUserAPI.replace('/0', `/${teamId}`),
                {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_email: email})
                }
            );

            const data = await response.json();

            if (!response.ok) {
                alert(data.detail || 'Ошибка добавления пользователя');
                return;
            }

            alert('Пользователь успешно добавлен в команду');
            input.value = '';
            location.reload()
        }

        async function updateTeam(teamId) {
            const newName = prompt('Новое название команды');
            if (!newName) return;

            const newDescription = prompt('Новое описание команды') || '';

            const url = URLS.teamsUpdateAPI.replace('/0', `/${teamId}`);

            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access')}`
                },
                body: JSON.stringify({
                    name: newName,
                    description: newDescription
                })
            });

            if (!response.ok) {
                const data = await response.json();
                alert(data.detail || 'Ошибка обновления команды');
                return;
            }

            alert('Команда обновлена');
            location.reload();
        }
    </script>
{% endblock %}