{% extends 'base.html' %}

{% block title %}
    Список пользователей
{% endblock %}

{% block content %}
    <h1>Список пользователей</h1>

    <table border="1" cellpadding="6">
        <thead>
        <tr>
            <th>ID</th>
            <th>Email</th>
            <th>ФИО</th>
            <th>Дата рождения</th>
            <th>Возраст</th>
            <th>Роль</th>
            <th>Команда</th>
            <th>Дата регистрации</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody id="users-body">
        <tr>
            <td colspan="8">Загрузка...</td>
        </tr>
        </tbody>
    </table>

    <p id="error" style="color: red"></p>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (!Auth.isAuthenticated()) {
                window.location.href = URLS.login;
                return;
            }

            const response = await fetchWithAuth(URLS.usersListAPI);

            if (response.status === 403) {
                document.getElementById('error').textContent =
                    'Доступ запрещён. Только для администраторов.';
                document.getElementById('users-body').innerHTML = '';
                return;
            }

            if (!response.ok) {
                document.getElementById('error').textContent =
                    'Ошибка загрузки пользователей';
                return;
            }

            const users = await response.json();
            const tbody = document.getElementById('users-body');
            tbody.innerHTML = '';

            users.forEach(user => {
                tbody.insertAdjacentHTML('beforeend', `
                    <tr data-email="${user.email}">
                        <td>${user.id}</td>
                        <td>${user.email}</td>
                        <td>${user.full_name}</td>
                        <td>${user.birthday ? new Date(user.birthday).toLocaleDateString() : '---'}</td>
                        <td>${user.age ?? '---'}</td>
                        <td>${user.role}</td>
                        <td>${user.team_name ?? '---'}</td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        <td>
                            <button onclick="deleteUser('${user.email}')">Удалить</button>
                        </td>
                    </tr>
                `);
            });
        });

        function getDeleteUserUrl(email) {
            return URLS.usersDeleteAPI.replace(
                'EMAIL_PLACEHOLDER',
                encodeURIComponent(email)
            );
        }


        async function deleteUser(email) {
            if (!confirm(`Удалить пользователя ${email}?`)) {
                return;
            }

            const response = await fetchWithAuth(
                getDeleteUserUrl(email),
                {method: 'DELETE'}
            );

            if (response.status === 403) {
                alert('Недостаточно прав');
                return;
            }

            if (!response.ok) {
                alert('Ошибка при удалении пользователя');
                return;
            }

            const row = document.querySelector(`tr[data-email="${email}"]`);
            if (row) {
                row.remove();
            }
        }
    </script>
{% endblock %}